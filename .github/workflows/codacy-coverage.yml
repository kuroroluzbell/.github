name: Codacy Test Coverage Reporter

# Propósito de este Workflow:
# Este flujo SOLO envía los resultados de tus pruebas (cobertura) a Codacy.
# 1. Recibe el archivo de cobertura generado por tus tests (ej. jacoco, lcov).
# 2. Se autentica con Codacy usando tu Token (Project o Account).
# 3. Envía el reporte para que Codacy pueda bloquear PRs si la cobertura baja.
#
# IMPORTANTE: Tus propios workflows deben correr los tests PRIMERO,
# generar el coverage, SUBIRLO COMO ARTIFACT, y luego invocar este archivo.
#
# Puedes usar uno de dos tipos de token:
# - CODACY_PROJECT_TOKEN: Un token por proyecto (en Project API settings)
# - CODACY_API_TOKEN: Un token de cuenta (en Account API settings)
#
# Ejemplo de cómo llamarlo desde tu API en Java:
# -------------------------------------------------------------------
# name: Java CI and Test Coverage
# on:
#   push:
#     branches-ignore: [ "main" ]
#   pull_request:
#     branches: [ "develop" ]
#
# jobs:
#   build_and_test:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v4
#       - name: Set up JDK 17
#         uses: actions/setup-java@v3
#         with:
#           java-version: '17'
#           distribution: 'temurin'
#
#       - name: Ejecutar Tests (Genera jacoco.xml)
#         run: mvn clean test jacoco:report
#
#       - name: Upload coverage report
#         uses: actions/upload-artifact@v4
#         with:
#           name: coverage-report
#           path: target/site/jacoco/jacoco.xml
#           retention-days: 1
#
#   cobertura:
#     needs: build_and_test
#     uses: tu-usuario/tu-repo/.github/workflows/codacy-coverage.yml@main
#     with:
#       coverage_report_path: 'target/site/jacoco/jacoco.xml'
#     secrets:
#       # OPCION 1: Project Token (un token por proyecto)
#       CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}
#       # OPCION 2: Account Token (un token para todos los proyectos)
#       CODACY_API_TOKEN: ${{ secrets.CODACY_API_TOKEN }}
#
# Ejemplo de cómo llamarlo desde tu frontend en React (usando Jest):
# -------------------------------------------------------------------
#       - name: Run Tests (Jest)
#         run: npm run test -- --coverage
#
#       - name: Upload coverage report
#         uses: actions/upload-artifact@v4
#         with:
#           name: coverage-report
#           path: coverage/lcov.info
#           retention-days: 1
#
#   cobertura:
#     needs: build_and_test
#     uses: tu-usuario/tu-repo/.github/workflows/codacy-coverage.yml@main
#     with:
#       coverage_report_path: 'coverage/lcov.info'
#     secrets:
#       # OPCION 1: Project Token (un token por proyecto)
#       CODACY_PROJECT_TOKEN: ${{ secrets.CODACY_PROJECT_TOKEN }}
#       # OPCION 2: Account Token (un token para todos los proyectos)
#       CODACY_API_TOKEN: ${{ secrets.CODACY_API_TOKEN }}
# -------------------------------------------------------------------

on:
  workflow_call:
    inputs:
      coverage_report_path:
        description: 'Ruta al archivo de reporte de cobertura (ej: target/site/jacoco/jacoco.xml o coverage/lcov.info)'
        required: true
        type: string
      coverage_artifact_name:
        description: 'Nombre del artifact de coverage (default: coverage-report)'
        required: false
        type: string
        default: coverage-report
    secrets:
      CODACY_PROJECT_TOKEN:
        required: false
      CODACY_API_TOKEN:
        required: false

jobs:
  report-coverage:
    name: Subir Cobertura a Codacy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download coverage report
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.coverage_artifact_name }}
          path: .

      - name: Get coverage file name
        id: coverage
        run: |
          COVERAGE_FILE=$(basename "${{ inputs.coverage_report_path }}")
          echo "file=$COVERAGE_FILE" >> $GITHUB_OUTPUT

      - name: Check which token is available
        id: token_check
        run: |
          if [ -n "${{ secrets.CODACY_PROJECT_TOKEN }}" ]; then
            echo "type=project" >> $GITHUB_OUTPUT
          fi

      - name: Run Codacy Coverage Reporter (Project Token)
        if: steps.token_check.outputs.type == 'project'
        uses: codacy/codacy-coverage-reporter-action@v1
        with:
          project-token: ${{ secrets.CODACY_PROJECT_TOKEN }}
          coverage-reports: ${{ steps.coverage.outputs.file }}

      - name: Run Codacy Coverage Reporter (Account Token)
        if: steps.token_check.outputs.type == 'account'
        uses: codacy/codacy-coverage-reporter-action@v1
        with:
          api-token: ${{ secrets.CODACY_API_TOKEN }}
          username: ${{ github.repository_owner }}
          project-name: ${{ github.repository }}
          coverage-reports: ${{ steps.coverage.outputs.file }}
