name: Version Check

on:
  workflow_call:
    secrets:
      GITHUB_TOKEN_CUSTOM:
        required: true
    inputs:
      version_file:
        description: 'The file containing the version number (e.g., pom.xml, package.json)'
        required: true
        type: string

jobs:
  check-version-bump:
    name: Revisar versión
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN_CUSTOM }}

      - name: Get current version
        id: current_version
        run: |
          if [[ "${{ inputs.version_file }}" == "package.json" ]]; then
            VERSION=$(node -p "require('./${{ inputs.version_file }}').version")
          elif [[ "${{ inputs.version_file }}" == "pom.xml" ]]; then
            VERSION=$(grep -m1 '<version>' ${{ inputs.version_file }} | sed -E 's/.*<version>(.*)<\/version>.*/\1/')
          else
            echo "Unsupported file: ${{ inputs.version_file }}"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Get base branch version
        id: base_version
        run: |
          BASE_BRANCH=""
          
          # Determinar la rama base
          if [[ -n "${{ github.base_ref }}" ]]; then
            BASE_BRANCH="${{ github.base_ref }}"
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            # Para push, usar la rama actual como referencia
            BASE_BRANCH="${{ github.ref_name }}"
          fi
          
          # Si está vacío, buscar una rama por defecto
          if [[ -z "$BASE_BRANCH" ]]; then
            echo "No se detectó rama base, buscando rama por defecto..."
            BASE_BRANCH=$(git branch -r --format='%(refname:short)' 2>/dev/null | grep -E '^origin/main$|^origin/master$' | head -n1)
          fi
          
          # Último intento: intentar con origin/main
          if [[ -z "$BASE_BRANCH" ]]; then
            BASE_BRANCH="main"
          fi
          
          echo "Rama base: $BASE_BRANCH"
          
          # Fetch de la rama base
          git fetch origin $BASE_BRANCH:$BASE_BRANCH --depth=1 2>/dev/null || true
          
          # Verificar que existe la rama
          if ! git show-ref --verify --quiet refs/heads/$BASE_BRANCH 2>/dev/null; then
            echo "⚠️ No se encontró la rama $BASE_BRANCH"
            echo "Verificando con tags..."
            git fetch --tags origin +refs/tags/*:refs/tags/* 2>/dev/null || true
          fi
          
          if [[ "${{ inputs.version_file }}" == "package.json" ]]; then
            if git show $BASE_BRANCH:${{ inputs.version_file }} >/dev/null 2>&1; then
              VERSION=$(git show $BASE_BRANCH:${{ inputs.version_file }} | node -p "require('stdin').version")
            else
              echo "⚠️ No se pudo obtener la versión de $BASE_BRANCH, saltando validación"
              echo "VERSION=0.0.0" >> $GITHUB_OUTPUT
              exit 0
            fi
          elif [[ "${{ inputs.version_file }}" == "pom.xml" ]]; then
            if git show $BASE_BRANCH:${{ inputs.version_file }} >/dev/null 2>&1; then
              VERSION=$(git show $BASE_BRANCH:${{ inputs.version_file }} | grep -m1 '<version>' | sed -E 's/.*<version>(.*)<\/version>.*/\1/')
            else
              echo "⚠️ No se pudo obtener la versión de $BASE_BRANCH, saltando validación"
              echo "VERSION=0.0.0" >> $GITHUB_OUTPUT
              exit 0
            fi
          else
            echo "Unsupported file: ${{ inputs.version_file }}"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Base version: $VERSION"

      - name: Compare versions
        run: |
          CURRENT=${{ steps.current_version.outputs.VERSION }}
          BASE=${{ steps.base_version.outputs.VERSION }}
          
          # Si la versión base es 0.0.0, significa que no se pudo comparar
          if [[ "$BASE" == "0.0.0" ]]; then
            echo "⚠️ No se pudo obtener la versión de la rama base. Validación saltada."
            exit 0
          fi
          
          echo "Versión actual: $CURRENT"
          echo "Versión base: $BASE"
          
          if [[ $(echo -e "$BASE\n$CURRENT" | sort -V | head -n1) != "$BASE" ]] && [[ "$CURRENT" != "$BASE" ]]; then
            echo "⚠️ Tu rama está desactualizada. La versión en ${{ github.base_ref }} es mayor ($BASE)"
            echo "Debes hacer merge o rebase de ${{ github.base_ref }} antes de crear el PR"
            exit 1
          fi
          
          if [[ "$CURRENT" == "$BASE" ]]; then
            echo "❌ No se detectó cambio de versión"
            echo "Debes incrementar la versión en ${{ inputs.version_file }} antes de hacer el PR"
            exit 1
          fi
          
          echo "✅ Versión incrementada: $BASE → $CURRENT"
